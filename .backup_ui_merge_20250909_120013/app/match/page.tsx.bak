"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import { AppShell } from "@/components/app-shell";

type Row = {
  id: string;
  peer: { id: string; name: string; photo?: string | null };
  lastMessage: string;
  lastAt: string;
};

export default function MatchPage() {
  const [data, setData] = useState<Row[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        const res = await fetch("/api/conversations", { cache: "no-store" });
        const json = await res.json();
        if (mounted) setData(json || []);
      } catch {}
      setLoading(false);
    })();
    return () => { mounted = false; }
  }, []);

  return (
    <AppShell title="Matches">
      <div className="max-w-2xl mx-auto w-full p-4">
        {loading ? (
          <div className="opacity-80">Memuat…</div>
        ) : data.length === 0 ? (
          <div className="rounded-2xl border border-zinc-700/40 bg-zinc-900/40 p-5 text-lg">
            Belum ada percakapan. Mulai swipe untuk menemukan match ??
          </div>
        ) : (
          <ul className="space-y-2">
            {data.map((c) => (
              <li key={c.id}>
                <Link
                  href={`/match/${c.id}`}
                  className="flex items-center gap-3 rounded-xl border border-zinc-700/40 bg-zinc-900/40 p-3 hover:bg-zinc-900/70 transition"
                >
                  {/* eslint-disable-next-line @next/next/no-img-element */}
                  <img
                    src={c.peer.photo || `https://i.pravatar.cc/64?u=${c.peer.id}`}
                    alt=""
                    className="h-10 w-10 rounded-full object-cover"
                  />
                  <div className="flex-1 min-w-0">
                    <div className="font-semibold truncate">{c.peer.name}</div>
                    <div className="text-sm opacity-70 truncate">{c.lastMessage}</div>
                  </div>
                  <div className="text-xs opacity-60">{new Date(c.lastAt).toLocaleDateString()}</div>
                </Link>
              </li>
            ))}
          </ul>
        )}
      </div>
    </AppShell>
  );
}